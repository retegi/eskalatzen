{% extends 'core/base.html' %}

{% load static %}

{% block title %}Hasiera{% endblock %}

{% block content %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <style>
        .marker-cluster-small {
        background-color: rgba(50, 94, 244, 0.6);
        }
        .marker-cluster-small div {
        background-color: rgba(50, 36, 242, 0.6);
        }
        .marker-cluster-medium {
        background-color: rgba(241, 211, 87, 0.6);
        }
        .marker-cluster-medium div {
        background-color: rgba(240, 194, 12, 0.6);
        }

        .marker-cluster-large {
        background-color: rgba(253, 156, 115, 0.6);
        }
        .marker-cluster-large div {
        background-color: rgba(241, 128, 23, 0.6);
        }
    </style>
    <style>
        body {
            padding: 5;
            margin: 0;
        }
        html, body, #map {
            height: 92%;
            width: 100vw;
        }
    </style>
    <div id="map" style="position: relative;" class="leaflet-container leaflet-touch leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0">
        <div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(0px, 0px, 0px);">
          <div class="leaflet-pane leaflet-tile-pane">
            <div class="leaflet-layer " style="z-index: 1; opacity: 1;">
              <div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 18; transform: translate3d(0px, 0px, 0px) scale(1);">
                <img alt="" role="presentation" src="https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/12/2046/1361?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw" class="leaflet-tile leaflet-tile-loaded" style="width: 512px; height: 512px; transform: translate3d(-200px, -347px, 0px); opacity: 1;"><img alt="" role="presentation" src="https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/12/2047/1361?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw" class="leaflet-tile leaflet-tile-loaded" style="width: 512px; height: 512px; transform: translate3d(312px, -347px, 0px); opacity: 1;">
                <img alt="" role="presentation" src="https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/12/2046/1362?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw" class="leaflet-tile leaflet-tile-loaded" style="width: 512px; height: 512px; transform: translate3d(-200px, 165px, 0px); opacity: 1;"><img alt="" role="presentation" src="https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/12/2047/1362?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw" class="leaflet-tile leaflet-tile-loaded" style="width: 512px; height: 512px; transform: translate3d(312px, 165px, 0px); opacity: 1;">
              </div>
            </div>
          </div>
        <div class="leaflet-pane leaflet-overlay-pane">
          <svg pointer-events="none" class="leaflet-zoom-animated" width="720" height="480" style="transform: translate3d(-60px, -40px, 0px);" viewBox="-60 -40 720 480"><g>
            <path class="leaflet-interactive" stroke="red" stroke-opacity="1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="#f03" fill-opacity="0.5" fill-rule="evenodd" d="M141.20355555554852,171.94704600190744a42,42 0 1,0 84,0 a42,42 0 1,0 -84,0 "></path><path class="leaflet-interactive" stroke="#3388ff" stroke-opacity="1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="#3388ff" fill-opacity="0.2" fill-rule="evenodd" d="M358 163L474 219L550 153z"></path></g>
          </svg>
        </div>
        <div class="leaflet-pane leaflet-shadow-pane">
          <img src="https://unpkg.com/leaflet@1.8.0/dist/images/marker-shadow.png" class="leaflet-marker-shadow leaflet-zoom-animated" style="margin-left: -12px; margin-top: -41px; width: 41px; height: 41px; transform: translate3d(300px, 247px, 0px);" alt=""></div><div class="leaflet-pane leaflet-marker-pane"><img src="https://unpkg.com/leaflet@1.8.0/dist/images/marker-icon.png" class="leaflet-marker-icon leaflet-zoom-animated leaflet-interactive" style="margin-left: -12px; margin-top: -41px; width: 25px; height: 41px; transform: translate3d(300px, 247px, 0px); z-index: 247;" alt="Marker" tabindex="0" role="button">
        </div>
        <div class="leaflet-pane leaflet-tooltip-pane"></div>
          <div class="leaflet-pane leaflet-popup-pane">
            <div class="leaflet-popup  leaflet-zoom-animated" style="opacity: 1; transform: translate3d(300px, 125px, 0px); bottom: -7px; left: -97px;">
              <div class="leaflet-popup-content-wrapper">
                <div class="leaflet-popup-content" style="width: 148px;">I am a standalone popup.
                </div>
              </div>
              <div class="leaflet-popup-tip-container">
                <div class="leaflet-popup-tip">
                </div>
              </div>
              <a class="leaflet-popup-close-button" role="button" aria-label="Close popup" href="#close"><span aria-hidden="true">×</span></a>
            </div>
          </div>
          <div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(1048050px, 697379px, 0px) scale(4096);">
          </div>
        </div>
        <div class="leaflet-control-container">
          <div class="leaflet-top leaflet-left">
            <div class="leaflet-control-zoom leaflet-bar leaflet-control">
              <a class="leaflet-control-zoom-in" href="#" title="Zoom in" role="button" aria-label="Zoom in" aria-disabled="false"><span aria-hidden="true">+</span></a>
              <a class="leaflet-control-zoom-out" href="#" title="Zoom out" role="button" aria-label="Zoom out" aria-disabled="false"><span aria-hidden="true">−</span></a>
            </div>
          </div>
          <div class="leaflet-top leaflet-right">
          </div>
          <div class="leaflet-bottom leaflet-left">
          </div>
          <div class="leaflet-bottom leaflet-right">
          <div class="leaflet-control-attribution leaflet-control">
            <a href="https://leafletjs.com" title="A JavaScript library for interactive maps">
              <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="12" height="8">
                <path fill="#4C7BE1" d="M0 0h12v4H0z"></path>
                <path fill="#FFD500" d="M0 4h12v3H0z"></path>
                <path fill="#E0BC00" d="M0 7h12v1H0z"></path>
              </svg> Leaflet</a> <span aria-hidden="true">|</span> Map data ©
            <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery ©
            <a href="https://www.mapbox.com/">Mapbox</a>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
        var map = L.map('map').setView([43.261290083983944, -1.9529219919471679], 10);
        var markers = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                 var childCount = cluster.getChildCount();
                 var c = ' marker-cluster-';
                 if (childCount < 10) {
                   c += 'small';
                 }
                 else if (childCount < 100) {
                   c += 'small';
                 }
                 else {
                   c += 'small';
                 }
                return new L.divIcon({ html: '<div><span>' + childCount + '</span></div>',
                                        className: 'marker-cluster' + c, iconSize: new L.Point(40, 40)  });
            }
        });
        var markersWeather = L.markerClusterGroup();
        var markersEuskalmet = L.markerClusterGroup();
        var markersCamping = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                 var childCount = cluster.getChildCount();
                 var c = ' marker-cluster-';
                 if (childCount < 10) {
                   c += 'medium';
                 }
                 else if (childCount < 100) {
                   c += 'medium';
                 }
                 else {
                   c += 'medium';
                 }
                return new L.divIcon({ html: '<div><span>' + childCount + '</span></div>',
                                        className: 'marker-cluster' + c, iconSize: new L.Point(40, 40)  });
            }
        });
        //osm layer
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        osm.addTo(map);

        var OpenTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        });
        //OpenTopoMap.addTo(map);

        // water color
        var watercolor = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: 'abcd',
            minZoom: 1,
            maxZoom: 16,
            ext: 'jpg'
        });
        // watercolor.addTo(map)

        // dark map
        var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        });
        // dark.addTo(map)
        // google street
        googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });
        // googleStreets.addTo(map);

        //google satellite
        googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });
        // googleSat.addTo(map)

        /*==============================================
                        LAYER CONTROL
        ================================================*/
        var baseMaps = {
            "OSM": osm,
            //"Water color map": watercolor,
            'Dark': dark,
            'Google Street': googleStreets,
            "Google Satellite": googleSat,
            "Topo Map": OpenTopoMap,
        };

        var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);

        ////// Camping
        var LeafIconCamping = L.Icon.extend({
            options: {
                iconSize:     [50, 50],
                iconAnchor:   [0, 0],
                popupAnchor:  [-0, -0]
            }
        });

        {% for spot in camping %}
            var img = "https://cdn-icons-png.flaticon.com/512/1054/1054092.png"
            var campingIcon = new LeafIconCamping({iconUrl: img});
            markersCamping.addLayer(L.marker([{{ spot.latitude }},{{ spot.longitude }}], {icon: campingIcon})
                .bindPopup("<a href={{ spot.website }}>{{ spot.title }}</a><br>" +
            "Herria: {{ spot.town }} <br>" +
            "webgunea: <a href={{ spot.website }}>{{ spot.website }}</a><br>" +
            "telefonoa: {{ spot.phone }}  <br>"
             ));
        {% endfor %}

        const d = new Date();
        let hour = d.getHours();
        let icon_code = "";
        var LeafIconWeather = L.Icon.extend({
            options: {
                iconSize:     [100, 100],
                iconAnchor:   [10, 0],
                popupAnchor:  [-0, -0]
            }
        });

        var LeafIconEuskalmet = L.Icon.extend({
            options: {
                iconSize:     [70, 70],
                iconAnchor:   [40, 80],
            }
        });

window.addEventListener("load", function meteoForecast() {
  var headers =
  {
    'accept':'application/json',
    'Authorization': "Bearer eyJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJtZXQwMS5hcGlrZXkiLCJpc3MiOiJUZWNuYWxpYSIsImV4cCI6MTY3NjIwNDc1OCwidmVyc2lvbiI6IjEuMC4wIiwiaWF0IjoxNjM4NDQ3OTU4LCJlbWFpbCI6ImFwcHMuaW5mcmEudGVjbmFsaWFAZ21haWwuY29tIn0.eVQczqFuUDXqSqE4bbc8XYxTxBuNnlJWnpf2dKd2cj9CNFJ6U6N3svz5rFrgpGqskwhkqEo4Bi7w-zgxFu4x_tYzeMX351guT0AFBjVWikCHXXRrPDf1rMJkTD_rNScIFyHHqhXdZ31vE8iJ9Z8zQiAFBUa8bkyehqX-C_96-CQmBBEh4bWW_P6-5nSMrrHH19-8dhT9bGeInXxPnGKBFqiwjJfsrqhpi4Ee6lvCyyeQD0ZJmnRozzqlr80r9N61WwHdWXpez3pdxElFsZ-zOkixkztqo157eTvRyPA1GchX1K3eTkQsLWPExtIZwcydXIYnxH1glWPIKLycLAfiOQ"
  };
  var options = {
    'method' : 'get',
    'contentType': 'application/json',
    'headers': headers,
    'muteHttpExceptions': true
  };

          const options_ = { year: 'numeric', month: 'numeric', day: 'numeric' };

          var today = new Date();
          console.log(today.toLocaleString(undefined, options_));
          console.log(today);
          var month = today.getMonth() + 1;
          var day = today.getDate();
          if (month < 10)
          {month = "0" + month};

          if (day < 10)
          {day = "0" + day};

          var date = today.getFullYear() + "/" + month + "/" + day;
          var date2 = today.getFullYear() + month + day;

        {% for spot in climbingspot %}
            {% if spot.enable %}

            var url = "https://api.euskadi.eus/euskalmet/weather/regions/{{spot.regionId}}/zones/{{spot.zoneId}}/locations/{{spot.locId}}/forecast/trends/at/" + date + "/for/" + date2;
            var response2 = fetch(url, options);

              fetch(url, options)
              .then(response2 => response2.json())
              .then(data => {
                console.log(data);
                var days = data["trendsByDate"]["set"];
                for (i=0;i<days.length;i++)
                {
                    var day_trend = days[i]["date"].split("-")[2].split("T")[0]
                    if (day == day_trend)
                    {
                        {% for owm in owms %}
                            if ("{{ owm.euskalmet }}" == days[i]["weather"]["id"])
                            {
                                var euskalmet_code = days[i]["weather"]["id"];
                                var img = "https://www.euskalmet.euskadi.eus/appcont/meteorologia/meteodat/images/" + euskalmet_code + ".png"
                                var img = "https://www.euskalmet.euskadi.eus/meteoassets/icons/euskalmet/{{ owm.euskalmet_new }}.svg"
                                //console.log(img2);
                            }
                        {% endfor %}
                    }
                }
                console.log(img, {{spot.latitude}}, {{spot.longitude}});

                var weatherIcon = new LeafIconEuskalmet({iconUrl: img});
                markersEuskalmet.addLayer(L.marker([{{ spot.latitude }},{{ spot.longitude }}], {icon: weatherIcon}));

              })
            {% endif %}
        {% endfor %}

        }, false);
        ////////////////// endEuskalmet

        {% for spot in climbingspot %}
            {% if spot.enable %}

            window.addEventListener('load', function(name){
                //fetch('https://api.openweathermap.org/data/2.5/onecall?lat={{ spot.latitude }}&&lon={{ spot.longitude }}&&exclude=current,hourly,minutely,alerts&units=metric&appid=32ce3717017406682b290a5dd99fbc99')
                fetch('https://api.openweathermap.org/data/2.5/weather?lat={{ spot.latitude }}&&lon={{ spot.longitude }}&units=metric&appid=32ce3717017406682b290a5dd99fbc99&lang=eu')
                .then(response => response.json())
                .then(data => {
                 console.log(data);
                 console.log(data['cod']);
                 console.log(icon_code = data['weather'][0]['icon']);
                if (data['cod'] == 200){
                    {% for owm in owms %}
                        icon_code = data['weather'][0]['icon'];
                        if (hour > 21 || hour < 6){
                            icon_code = icon_code.replace("d", "n");
                        }
                        if ("{{ owm.owm }}" == icon_code){
                            console.log("owm_code", icon_code);
                            var img = "{{ owm.path }}";
                        }
                    {% endfor %}
                    console.log(img);
                    console.log('{{ spot.town }}');
                    var weatherIcon = new LeafIconWeather({iconUrl: img});
                    markersWeather.addLayer(L.marker([{{ spot.latitude }},{{ spot.longitude }}], {icon: weatherIcon}).bindPopup("<a href={{ spot.province }}/{{ spot.title }}>{{ spot.title }}</a><br>" +
                        "Arkaitza: {{ spot.stone }} <br>" +
                        "Zailtasuna: {{ spot.difficulty }} III / 8a"
                        ));

                }
                })
            })

            console.log("{% url 'core:detail_view' spot.id %}");
            markers.addLayer(L.marker([{{ spot.latitude }},{{ spot.longitude }}])
                        .bindPopup("<a href="{% url 'core:detail_view' spot.id %}">{{ spot.title }}</a><br>" +
                    "Arkaitza: {{ spot.stone }} <br>" +
                    "Zailtasuna: {{ spot.difficulty }} III / 8a"
                    ));
                    //.bindPopup("<a href={{ spot.province }}/{{ spot.title }}>{{ spot.title }}</a><br>" +

            {% endif %}
        {% endfor %}




window.addEventListener("load", function meteoForecast() {
  var headers =
  {
    'accept':'application/json',
    'Authorization': "Bearer eyJhbGciOiJSUzI1NiJ9.eyJhdWQiOiJtZXQwMS5hcGlrZXkiLCJpc3MiOiJUZWNuYWxpYSIsImV4cCI6MTY3NjIwNDc1OCwidmVyc2lvbiI6IjEuMC4wIiwiaWF0IjoxNjM4NDQ3OTU4LCJlbWFpbCI6ImFwcHMuaW5mcmEudGVjbmFsaWFAZ21haWwuY29tIn0.eVQczqFuUDXqSqE4bbc8XYxTxBuNnlJWnpf2dKd2cj9CNFJ6U6N3svz5rFrgpGqskwhkqEo4Bi7w-zgxFu4x_tYzeMX351guT0AFBjVWikCHXXRrPDf1rMJkTD_rNScIFyHHqhXdZ31vE8iJ9Z8zQiAFBUa8bkyehqX-C_96-CQmBBEh4bWW_P6-5nSMrrHH19-8dhT9bGeInXxPnGKBFqiwjJfsrqhpi4Ee6lvCyyeQD0ZJmnRozzqlr80r9N61WwHdWXpez3pdxElFsZ-zOkixkztqo157eTvRyPA1GchX1K3eTkQsLWPExtIZwcydXIYnxH1glWPIKLycLAfiOQ"
  };
  var options = {
    'method' : 'get',
    'contentType': 'application/json',
    'headers': headers,
    'muteHttpExceptions': true
  };
  const options_ = { year: 'numeric', month: 'numeric', day: 'numeric' };

  var today = new Date();
  console.log(today.toLocaleString(undefined, options_));
  console.log(today);
  var month = today.getMonth() + 1;
  if (month < 10)
  {month = "0" + month};

  var date = today.getFullYear() + "/" + month + "/" + today.getDate();
  var date2 = today.getFullYear() + month + today.getDate();
  console.log(date);
  var urls = "https://api.euskadi.eus/euskalmet/weather/regions/basque_country/forecast/at/" + date + "/for/" + date2;
  console.log(urls);

  const response = fetch(urls, options);

  fetch(urls, options)
  .then(response => response.json())
  .then(data => {
        const root = document.getElementById('root');
        const tempTabla = document.getElementById('tempTabla');

        console.log("Kaixo");
        console.log(data);
        console.log(data['forecastTextByLang']['BASQUE']);
        console.log(data['citiesTemperatureRange'].length);
        var htmlTabla= "";
        for (var i=0; i < data['citiesTemperatureRange'].length; i++){
            console.log(data['citiesTemperatureRange'][i]['temperature']['min']);
            console.log(data['citiesTemperatureRange'][i]['temperature']['max']);
            let location = data['citiesTemperatureRange'][i]['locationId'];
            {% for spot in euskalmet %}
                if (location.includes('{{ spot.town }}')) {
                        console.log('{{ spot.town }} {{ spot.latitude }} {{ spot.longitude }}');
                    var img = "https://www.euskalmet.euskadi.eus/meteoassets/icons/euskalmet/i00d.svg"


                    //var weatherIcon = new LeafIconEuskalmet({iconUrl: img});
                    //markersEuskalmet.addLayer(L.marker([{{ spot.latitude }},{{ spot.longitude }}], {icon: weatherIcon}));
                }
            {% endfor %}
        }

        });

}, false);

        map.addLayer(markers);
        map.addLayer(markersWeather);
        map.addLayer(markersCamping);
        map.addLayer(markersEuskalmet);

        var overlayMaps = {
            "Eskalada guneak": markers,
            "Eguraldia": markersWeather,
            "Kanpina": markersCamping,
            "Euskalmet": markersEuskalmet
        };

        L.control.layers(baseMaps, overlayMaps, { collapsed: true }).addTo(map);

        // create a red polygon from an array of LatLng points
        var latlngs = [
        [43.39331315693846, -1.7899676449060937],
        [43.29568210994661, -1.7297933953698401],
        [43.27636577758222, -1.792869845672187],
        [43.245320138844164, -1.798524975699294],
        [43.20687279331388, -1.8805985638339584],
        [43.221447460161436, -1.9130687380851212],
        [43.13438911044534, -1.9034042512985236],
        [43.10413685247373, -1.954674254775563],
        [42.980053241529625, -2.039349934710005],
        [42.93617421849773, -2.178290543021023],
        [43.02715939054782, -2.5102654513115055],
        [43.138052003878265, -2.5021859630564394],
        [43.1829085490213, -2.482715418405741],
        [43.32318595094074, -2.410915777900156],
        [43.311719831492724, -2.219716295878033],
        [43.28741860143101, -2.166958518187822],
        [43.37194496763773, -1.8624326190012657]];

        var polygonGipuzkoa = L.polygon(latlngs, {color: 'blue',
                                                  opacity: 0.6,
                                                  fillOpacity: 0.2,
                                                  interactive: true});
        polygonGipuzkoa.addTo(map);

        // zoom the map to the polygon
        map.fitBounds(polygon.getBounds());

        L.control.locate({
            flyTo: true,
            keepCurrentZoomLevel: true,
            initialZoomLevel: 10
            }).addTo(map);
        map.on('mouseover', function () {
        console.log('your mouse is over the map')
        })


    </script>
{% endblock %}


